#!/bin/bash

# OpenDIF Pre-commit Hook
# Validates quality checks, builds, and tests for staged services only
# Compatible with macOS default Bash 3.2+

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== OpenDIF Pre-commit Validation ===${NC}\n"

# Function to get service path by name
get_service_path() {
    case "$1" in
        portal-backend) echo "portal-backend" ;;
        audit-service) echo "audit-service" ;;
        orchestration-engine) echo "exchange/orchestration-engine" ;;
        consent-engine) echo "exchange/consent-engine" ;;
        policy-decision-point) echo "exchange/policy-decision-point" ;;
        member-portal) echo "portals/member-portal" ;;
        admin-portal) echo "portals/admin-portal" ;;
        consent-portal) echo "portals/consent-portal" ;;
        *) echo "" ;;
    esac
}

# All available services
ALL_SERVICES="portal-backend audit-service orchestration-engine consent-engine policy-decision-point member-portal admin-portal consent-portal"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}No staged files found. Skipping validation.${NC}"
    exit 0
fi

echo -e "${BLUE}Staged files:${NC}"
echo "$STAGED_FILES" | sed 's/^/  /'
echo ""

# Detect affected services
AFFECTED_SERVICES=""

for service in $ALL_SERVICES; do
    path=$(get_service_path "$service")
    if [ -n "$path" ]; then
        # Check if any staged file belongs to this service
        if echo "$STAGED_FILES" | grep -q "^${path}/"; then
            if [ -z "$AFFECTED_SERVICES" ]; then
                AFFECTED_SERVICES="$service"
            else
                AFFECTED_SERVICES="$AFFECTED_SERVICES $service"
            fi
        fi
    fi
done

# Remove duplicates and sort
if [ -n "$AFFECTED_SERVICES" ]; then
    AFFECTED_SERVICES=$(echo "$AFFECTED_SERVICES" | tr ' ' '\n' | sort -u | tr '\n' ' ')
fi

if [ -z "$AFFECTED_SERVICES" ]; then
    echo -e "${YELLOW}No service-specific changes detected. Skipping validation.${NC}"
    echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
    exit 0
fi

echo -e "${BLUE}Affected services: ${AFFECTED_SERVICES}${NC}\n"

# Track overall status
FAILED_SERVICES=""
VALIDATION_FAILED=0

# Function to run validation for a service
validate_service() {
    local service=$1
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}Validating: ${service}${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
    
    local service_failed=0
    
    # Run quality-check
    echo -e "${YELLOW}[1/3] Running quality checks...${NC}"
    if ! make quality-check "$service" 2>&1 | sed 's/^/  /'; then
        echo -e "${RED}✗ Quality check failed for ${service}${NC}\n"
        service_failed=1
    else
        echo -e "${GREEN}✓ Quality check passed for ${service}${NC}\n"
    fi
    
    # Run validate-build
    echo -e "${YELLOW}[2/3] Running build validation...${NC}"
    if ! make validate-build "$service" 2>&1 | sed 's/^/  /'; then
        echo -e "${RED}✗ Build validation failed for ${service}${NC}\n"
        service_failed=1
    else
        echo -e "${GREEN}✓ Build validation passed for ${service}${NC}\n"
    fi
    
    # Run validate-test
    echo -e "${YELLOW}[3/3] Running test validation...${NC}"
    if ! make validate-test "$service" 2>&1 | sed 's/^/  /'; then
        echo -e "${RED}✗ Test validation failed for ${service}${NC}\n"
        service_failed=1
    else
        echo -e "${GREEN}✓ Test validation passed for ${service}${NC}\n"
    fi
    
    if [ $service_failed -eq 1 ]; then
        if [ -z "$FAILED_SERVICES" ]; then
            FAILED_SERVICES="$service"
        else
            FAILED_SERVICES="$FAILED_SERVICES $service"
        fi
        VALIDATION_FAILED=1
    fi
}

# Validate each affected service
for service in $AFFECTED_SERVICES; do
    validate_service "$service"
done

# Final summary
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}Validation Summary${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "${RED}✗ Pre-commit validation FAILED${NC}\n"
    echo -e "${RED}Failed services:${NC}"
    for service in $FAILED_SERVICES; do
        echo -e "  ${RED}- ${service}${NC}"
    done
    echo -e "\n${YELLOW}Fix the issues and try committing again.${NC}"
    echo -e "${YELLOW}To bypass the hook temporarily (not recommended):${NC}"
    echo -e "${YELLOW}  git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}✓ All pre-commit checks passed for:${NC}"
    for service in $AFFECTED_SERVICES; do
        echo -e "  ${GREEN}- ${service}${NC}"
    done
    echo -e "\n${GREEN}Proceeding with commit...${NC}"
    exit 0
fi