name: Reusable Go Service Validation

on:
    workflow_call:
        inputs:
            service_path:
                description: "Path to the service directory (e.g., 'audit-service' or 'exchange/orchestration-engine')"
                required: true
                type: string
            service_name:
                description: "Service name for image tagging (e.g., 'audit-service', 'orchestration-engine')"
                required: true
                type: string
            needs_postgres:
                description: "Whether the service requires PostgreSQL for tests"
                required: false
                type: boolean
                default: false
            test_db_name:
                description: "PostgreSQL database name for tests (required if needs_postgres is true)"
                required: false
                type: string
                default: "test_db"
            go_sum_path:
                description: "Path to go.sum for cache key (defaults to service_path/go.sum)"
                required: false
                type: string
                default: ""

env:
    GO_VERSION: "1.24"
    REGISTRY: ghcr.io
    TEST_DB_USER: postgres
    TEST_DB_PASS: password

jobs:
    validate:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        services:
            postgres:
                image: ${{ inputs.needs_postgres && 'postgres:15' || '' }}
                env:
                    POSTGRES_USER: ${{ env.TEST_DB_USER }}
                    POSTGRES_PASSWORD: ${{ env.TEST_DB_PASS }}
                    POSTGRES_DB: ${{ inputs.test_db_name }}
                ports:
                    - 5432:5432
                options: >-
                    ${{ inputs.needs_postgres && '--health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5' || '' }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles(inputs.go_sum_path || format('{0}/go.sum', inputs.service_path)) }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Run Go Mod Tidy
              run: cd ${{ inputs.service_path }} && go mod tidy

            - name: Check for unclean Go Mod
              run: |
                  if ! git diff --exit-code -- ${{ inputs.service_path }}/go.mod ${{ inputs.service_path }}/go.sum; then
                    echo "::error::go.mod or go.sum files have uncommitted changes. Please run 'go mod tidy' and commit."
                    git diff -- ${{ inputs.service_path }}/go.mod ${{ inputs.service_path }}/go.sum
                    exit 1
                  fi
                  echo "Go mod files are clean."

            - name: Build application
              run: cd ${{ inputs.service_path }} && go build .

            - name: Run unit & integration tests
              env:
                  TEST_DB_HOST: ${{ inputs.needs_postgres && 'localhost' || '' }}
                  TEST_DB_PORT: ${{ inputs.needs_postgres && '5432' || '' }}
                  TEST_DB_USERNAME: ${{ inputs.needs_postgres && env.TEST_DB_USER || '' }}
                  TEST_DB_PASSWORD: ${{ inputs.needs_postgres && env.TEST_DB_PASS || '' }}
                  TEST_DB_DATABASE: ${{ inputs.needs_postgres && inputs.test_db_name || '' }}
                  TEST_DB_SSLMODE: ${{ inputs.needs_postgres && 'disable' || '' }}
              run: cd ${{ inputs.service_path }} && go test ./... -count=1

            - name: Set lowercase repository name
              id: repo
              run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ${{ inputs.service_path }}/Dockerfile
                  push: false
                  load: true
                  tags: ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/${{ inputs.service_name }}:pr-${{ github.event.pull_request.number || 'manual' }}
                  build-args: |
                      SERVICE_PATH=${{ inputs.service_path }}
                      BUILD_VERSION=${{ github.sha }}
                      BUILD_TIME=${{ github.event.pull_request.updated_at || github.run_id || '2025-01-01T00:00:00Z' }}
                      GIT_COMMIT=${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/${{ inputs.service_name }}:pr-${{ github.event.pull_request.number || 'manual' }}
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ inputs.service_name }}-binary
                  path: ${{ inputs.service_path }}/${{ inputs.service_name }}
                  retention-days: 1
