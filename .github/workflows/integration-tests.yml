name: Integration Tests

on:
  # Run on pull requests only (validation before merge)
  pull_request:
    paths:
      - 'tests/integration/**'
      - 'exchange/orchestration-engine/**'
      - 'exchange/policy-decision-point/**'
      - 'exchange/consent-engine/**'
      - 'exchange/shared/**'
      - '.github/workflows/integration-tests.yml'
  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.22'
  TEST_TIMEOUT: 30m

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('tests/integration/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install test dependencies
        working-directory: tests/integration
        run: |
          go mod download
          go mod tidy

      - name: Check for unclean Go Mod
        working-directory: tests/integration
        run: |
          if ! git diff --exit-code go.mod go.sum; then
            echo "::error::go.mod or go.sum files have uncommitted changes. Please run 'go mod tidy' and commit."
            git diff go.mod go.sum
            exit 1
          fi
          echo "Go mod files are clean."

      - name: Start Docker Compose services
        working-directory: tests/integration
        run: |
          echo "üöÄ Starting Docker Compose services..."
          docker compose -f docker-compose.test.yml up -d
          
          echo "üìã Checking service status..."
          docker compose -f docker-compose.test.yml ps

      - name: Wait for services to be healthy
        working-directory: tests/integration
        run: |
          echo "‚è≥ Waiting for all services to be healthy..."
          
          check_health() {
            local service_name=$1
            local health_url=$2
            local max_attempts=30
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              if curl -f -s $health_url > /dev/null 2>&1; then
                echo "‚úÖ $service_name is healthy"
                return 0
              fi
              echo "  Waiting for $service_name... (attempt $attempt/$max_attempts)"
              sleep 2
              attempt=$((attempt + 1))
            done
            
            echo "‚ùå $service_name failed to become healthy"
            echo "Service logs:"
            docker compose -f docker-compose.test.yml logs $service_name
            return 1
          }
          
          # Wait for databases first
          sleep 10
          
          # Check each service health endpoint
          check_health "policy-decision-point" "http://localhost:8082/health" || exit 1
          check_health "consent-engine" "http://localhost:8081/health" || exit 1
          check_health "orchestration-engine" "http://localhost:4000/health" || exit 1
          
          echo "üéâ All services are healthy and ready!"

      - name: Run integration tests
        working-directory: tests/integration
        env:
          GO_ENV: test
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
        run: |
          echo "üß™ Running integration tests..."
          go test -v -race -timeout ${{ env.TEST_TIMEOUT }} ./...

      - name: Show service logs on failure
        if: failure()
        working-directory: tests/integration
        run: |
          echo "=== Docker Compose Services Status ==="
          docker compose -f docker-compose.test.yml ps
          
          echo ""
          echo "=== All Service Logs ==="
          docker compose -f docker-compose.test.yml logs
          
          echo ""
          echo "=== PDP Database Logs ==="
          docker compose -f docker-compose.test.yml logs pdp-db
          
          echo ""
          echo "=== CE Database Logs ==="
          docker compose -f docker-compose.test.yml logs ce-db

      - name: Cleanup
        if: always()
        working-directory: tests/integration
        run: |
          echo "üßπ Cleaning up test infrastructure..."
          docker compose -f docker-compose.test.yml down -v
          echo "‚úÖ Cleanup complete"
