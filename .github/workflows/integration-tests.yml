name: OpenDIF CI/CD Pipeline

on:
  # Run on pushes to main (for deployment)
  push:
    branches:
      - main
  # Run on pull requests to main (for testing)
  pull_request:
    branches:
      - main

# Reusable workflow inputs/outputs could be added here if needed
env:
  GO_VERSION: '1.24'
  TEST_TIMEOUT: 30m

jobs:
  #
  # JOB 1: Test the code before merging
  #
  build_and_test:
    name: Build & Run Go Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('tests/integration/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install test dependencies
        working-directory: tests/integration
        run: |
          go mod download
          go mod tidy

      - name: Set up Docker Compose for Go tests
        working-directory: tests/integration
        run: |
          echo "Starting Docker Compose services for Go tests..."
          docker compose -f docker-compose.test.yml up -d
          
          echo "Waiting for services to be ready..."
          sleep 15
          
          # Health check function
          check_service() {
            local service=$1
            local max_attempts=10
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              # Check for 'healthy' or 'running' (as a fallback)
              if docker compose -f docker-compose.test.yml ps $service | grep -q "healthy\|running"; then
                echo "✅ $service is ready"
                return 0
              fi
              echo "⏳ Waiting for $service... (attempt $attempt/$max_attempts)"
              sleep 3
              attempt=$((attempt + 1))
            done
            
            echo "❌ $service failed to start"
            docker compose -f docker-compose.test.yml logs $service
            return 1
          }
          
          # Check each service
          check_service "pdp-db" || exit 1
          check_service "policy-decision-point" || exit 1
          
          echo "All infrastructure services are ready!"

      - name: Run Go Integration Tests
        working-directory: tests/integration
        env:
          GO_ENV: test
          USE_COMPOSE: "true"
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
        run: |
          echo "Running Go integration tests..."
          go test -v -timeout ${{ env.TEST_TIMEOUT }} ./...

      - name: Cleanup Go test infrastructure
        if: always()
        working-directory: tests/integration
        run: |
          echo "Stopping test infrastructure..."
          docker compose -f docker-compose.test.yml down -v

  #
  # JOB 2: Deploy and check the live environment
  #
  deploy_and_smoke_test:
    name: Deploy & Run Shell Smoke Tests
    runs-on: ubuntu-latest
    needs: build_and_test
    # This job only runs on a push to main, NOT on pull requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env.local file
        working-directory: exchange
        run: |
          if [ ! -f .env.local ]; then
            echo "Creating .env.local with default values..."
            {
              echo "ENVIRONMENT=local"
              echo "LOG_LEVEL=info"
              echo "LOG_FORMAT=text"
              echo "PORT_PDP=8082"
              echo "PORT_CE=8081"
              echo "PORT_OE=4000"
              echo "BUILD_VERSION=ci"
              echo "BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              echo "GIT_COMMIT=${{ github.sha }}"
            } > .env.local
          fi

      - name: Start Exchange Services
        working-directory: exchange
        run: |
          echo "Starting Exchange Services (Docker)..."
          docker compose --env-file .env.local up --build -d
          
          echo "Waiting for services to be ready..."
          sleep 30
          
          # Health check function
          check_service_health() {
            local service_name=$1
            local health_url=$2
            local max_attempts=10
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              if curl -f -s $health_url > /dev/null; then
                echo "✅ $service_name is healthy"
                return 0
              fi
              echo "⏳ Waiting for $service_name to be ready... (attempt $attempt/$max_attempts)"
              sleep 5
              attempt=$((attempt + 1))
            done
            
            echo "❌ $service_name failed to start"
            docker compose logs
            return 1
          }
          
          # Check each service
          check_service_health "PDP" "http://localhost:8082/health" || exit 1
          check_service_health "Consent Engine" "http://localhost:8081/health" || exit 1
          echo "All exchange services are running!"

      - name: Install shell dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Make shell scripts executable
        working-directory: tests/integration
        run: |
          chmod +x *.sh
          ls -la *.sh

      - name: Run Shell Smoke Tests
        working-directory: tests/integration
        run: |
          echo "Running shell smoke tests..."
          
          # Run tests if they exist
          [ -f "test-consent-flow.sh" ] && echo "Running consent flow tests..." && ./test-consent-flow.sh
          [ -f "test-complete-flow.sh" ] && echo "Running complete flow tests..." && ./test-complete-flow.sh
          
          echo "Smoke tests completed."

      - name: Show service logs on failure
        if: failure()
        working-directory: exchange
        run: |
          echo "=== Exchange Services Logs ==="
          docker compose logs

      - name: Cleanup services
        if: always()
        working-directory: exchange
        run: |
          echo "Cleaning up services..."
          docker compose down -v

  #
  # JOB 3: Optional - Build and push Docker images
  #
  build_and_push_images:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: build_and_test
    # Only run on pushes to main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env.local file
        working-directory: exchange
        run: |
          if [ ! -f .env.local ]; then
            echo "Creating .env.local with default values..."
            {
              echo "ENVIRONMENT=local"
              echo "LOG_LEVEL=info"
              echo "LOG_FORMAT=text"
              echo "PORT_PDP=8082"
              echo "PORT_CE=8081"
              echo "PORT_OE=4000"
              echo "BUILD_VERSION=ci"
              echo "BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              echo "GIT_COMMIT=${{ github.sha }}"
            } > .env.local
          fi

      - name: Build Exchange Services Images
        working-directory: exchange
        run: |
          echo "Building Exchange Services (Docker)..."
          docker compose --env-file .env.local build

      - name: Login to Container Registry
        # Uncomment and configure when you have a registry
        # uses: docker/login-action@v3
        # with:
        #   registry: your-registry.com
        #   username: ${{ secrets.REGISTRY_USERNAME }}
        #   password: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          echo "Container registry login would go here"
          echo "For now, this step is disabled. Uncomment when you configure your registry."

      - name: Push Images
        # Uncomment when ready to push
        # run: |
        #   docker push your-registry/opendif-service:latest
        run: |
          echo "Image push would go here"
          echo "Configure your registry and uncomment the push commands."