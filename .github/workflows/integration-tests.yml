name: Integration Tests

on:
  # Run on pull requests only (validation before merge)
  pull_request:
    paths:
      - 'tests/integration/**'
      - 'exchange/orchestration-engine/**'
      - 'exchange/policy-decision-point/**'
      - 'exchange/consent-engine/**'
      - 'exchange/shared/**'
      - '.github/workflows/integration-tests.yml'
  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'
  TEST_TIMEOUT: 30m

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('tests/integration/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install test dependencies
        working-directory: tests/integration
        run: |
          go mod download
          go mod tidy

      - name: Check for unclean Go Mod
        working-directory: tests/integration
        run: |
          if ! git diff --exit-code go.mod go.sum; then
            echo "::error::go.mod or go.sum files have uncommitted changes. Please run 'go mod tidy' and commit."
            git diff go.mod go.sum
            exit 1
          fi
          echo "Go mod files are clean."

      - name: Start Database Services
        working-directory: tests/integration
        run: |
          echo "üöÄ Starting Database services..."
          docker compose -f docker-compose.db.yml up -d
          
          echo "‚è≥ Waiting for databases to be healthy..."
          sleep 10
          
          # Basic check to ensure containers are running
          docker compose -f docker-compose.db.yml ps

      - name: Build Services
        run: |
          echo "üî® Building Policy Decision Point..."
          go build -o tests/integration/bin/policy-decision-point ./exchange/policy-decision-point
          
          echo "üî® Building Consent Engine..."
          go build -o tests/integration/bin/consent-engine ./exchange/consent-engine
          
          echo "üî® Building Orchestration Engine..."
          go build -o tests/integration/bin/orchestration-engine ./exchange/orchestration-engine

      - name: Start Services
        working-directory: tests/integration
        env:
          # PDP Config
          PDP_PORT: 8082
          PDP_DB_HOST: localhost
          PDP_DB_PORT: 5433
          
          # CE Config
          CE_PORT: 8081
          CE_DB_HOST: localhost
          CE_DB_PORT: 5434
          
          # OE Config
          OE_PORT: 4000
        run: |
          mkdir -p logs
          
          echo "üöÄ Starting Policy Decision Point..."
          # Running with env vars mapping to what the code expects (based on docker-compose.test.yml analysis)
          PORT=8082 \
          LOG_LEVEL=debug \
          DB_SSLMODE=disable \
          CHOREO_OPENDIF_DATABASE_HOSTNAME=localhost \
          CHOREO_OPENDIF_DATABASE_PORT=5433 \
          CHOREO_OPENDIF_DATABASE_USERNAME=postgres \
          CHOREO_OPENDIF_DATABASE_PASSWORD=password \
          CHOREO_OPENDIF_DATABASE_DATABASENAME=policy_db \
          RUN_MIGRATION=true \
          ./bin/policy-decision-point > logs/pdp.log 2>&1 &
          PDP_PID=$!
          echo "PDP PID: $PDP_PID"
          
          echo "üöÄ Starting Consent Engine..."
          PORT=8081 \
          LOG_LEVEL=debug \
          CHOREO_DB_CE_HOSTNAME=localhost \
          CHOREO_DB_CE_PORT=5434 \
          CHOREO_DB_CE_USERNAME=postgres \
          CHOREO_DB_CE_PASSWORD=password \
          CHOREO_DB_CE_DATABASENAME=consent_db \
          CHOREO_OPENDIF_DATABASE_HOSTNAME=localhost \
          CHOREO_OPENDIF_DATABASE_PORT=5434 \
          CHOREO_OPENDIF_DATABASE_USERNAME=postgres \
          CHOREO_OPENDIF_DATABASE_PASSWORD=password \
          CHOREO_OPENDIF_DATABASE_DATABASENAME=consent_db \
          DB_SSLMODE=disable \
          ASGARDEO_JWKS_URL="https://www.googleapis.com/oauth2/v3/certs" \
          ASGARDEO_ISSUER="https://accounts.google.com" \
          ASGARDEO_AUDIENCE="test-audience" \
          ASGARDEO_ORG_NAME="test-org" \
          ./bin/consent-engine > logs/ce.log 2>&1 &
          CE_PID=$!
          echo "CE PID: $CE_PID"
          
          echo "‚è≥ Waiting for PDP and CE to be ready..."
          sleep 5
          
          echo "üöÄ Starting Orchestration Engine..."
          PORT=4000 \
          LOG_LEVEL=debug \
          PDP_URL=http://localhost:8082 \
          CONSENT_ENGINE_URL=http://localhost:8081 \
          CONFIG_PATH=$(pwd)/config.json \
          ./bin/orchestration-engine > logs/oe.log 2>&1 &
          OE_PID=$!
          echo "OE PID: $OE_PID"
          
          echo "‚è≥ Waiting for all services to initialize..."
          sleep 10

      - name: Check Service Health
        run: |
          check_health() {
            local service_name=$1
            local health_url=$2
            if curl -s -f "$health_url" > /dev/null; then
              echo "‚úÖ $service_name is healthy"
              return 0
            else
              echo "‚ùå $service_name is NOT healthy"
              return 1
            fi
          }
          
          check_health "Policy Decision Point" "http://localhost:8082/health" || (cat tests/integration/logs/pdp.log && exit 1)
          check_health "Consent Engine" "http://localhost:8081/health" || (cat tests/integration/logs/ce.log && exit 1)
          check_health "Orchestration Engine" "http://localhost:4000/health" || (cat tests/integration/logs/oe.log && exit 1)

      - name: Run integration tests
        working-directory: tests/integration
        env:
          GO_ENV: test
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
        run: |
          echo "üß™ Running integration tests..."
          go test -v -race -timeout ${{ env.TEST_TIMEOUT }} ./...

      - name: Show service logs on failure
        if: failure()
        working-directory: tests/integration
        run: |
          echo "=== Docker Compose Services Status ==="
          docker compose -f docker-compose.test.yml ps
          
          echo ""
          echo "=== All Service Logs ==="
          docker compose -f docker-compose.test.yml logs
          
          echo ""
          echo "=== PDP Database Logs ==="
          docker compose -f docker-compose.test.yml logs pdp-db
          
          echo ""
          echo "=== CE Database Logs ==="
          docker compose -f docker-compose.test.yml logs ce-db

      - name: Cleanup
        if: always()
        working-directory: tests/integration
        run: |
          echo "üßπ Cleaning up test infrastructure..."
          docker compose -f docker-compose.test.yml down -v
          echo "‚úÖ Cleanup complete"
