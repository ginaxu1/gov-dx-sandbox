services:
  # Policy Decision Point Database
  pdp-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: policy_db
    ports:
      - "5433:5432" # Map to 5433 to avoid conflict with local postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Policy Decision Point Service
  policy-decision-point:
    image: policy-decision-point:test
    build:
      context: ../../exchange/policy-decision-point
      dockerfile: Dockerfile
    environment:
      # Service listens on 8082 internally, but mapped to 8083 on host (see ports section)
      PORT: 8082
      LOG_LEVEL: debug
      DB_HOST: pdp-db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      DB_NAME: policy_db
      DB_SSLMODE: disable
      # Choreo env vars compatibility
      CHOREO_OPENDIF_DATABASE_HOSTNAME: pdp-db
      CHOREO_OPENDIF_DATABASE_PORT: 5432
      CHOREO_OPENDIF_DATABASE_USERNAME: postgres
      CHOREO_OPENDIF_DATABASE_DATABASENAME: policy_db
      RUN_MIGRATION: "true"
    ports:
      - "8083:8082"
    depends_on:
      pdp-db:
        condition: service_healthy
