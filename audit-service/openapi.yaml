openapi: 3.0.3
info:
  title: Audit Service API
  description: |
    Audit Service API for tracking and retrieving audit logs.
    
    This service provides a generalized audit logging API suitable for distributed tracing
    and various audit use cases. It supports creating and querying audit logs with
    flexible filtering and pagination.
  version: 1.0.0
  contact:
    name: OpenDIF Team
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3001
    description: Local Development Environment

paths:
  /health:
    get:
      summary: Health Check
      description: Check if the audit service is running and healthy
      operationId: healthCheck
      tags:
        - Health
      security: []
      
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: "audit-service"
                  status:
                    type: string
                    example: "healthy"
        '500':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: "Service unavailable"

  /version:
    get:
      summary: Version Information
      description: Get version and build information for the audit service
      operationId: getVersion
      tags:
        - Health
      security: []
      
      responses:
        '200':
          description: Version information
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    example: "1.0.0"
                  buildTime:
                    type: string
                    example: "2024-01-15T10:30:00Z"
                  gitCommit:
                    type: string
                    example: "abc123def"
                  service:
                    type: string
                    example: "audit-service"

  /api/audit-logs:
    post:
      summary: Create Audit Log
      description: |
        Create a generalized audit log entry suitable for distributed tracing.
        This endpoint is used by various microservices (OE, PDP, CE, Provider) to log
        key events in a request flow.
        
        **Required Fields:**
        - `status`: SUCCESS or FAILURE
        - `actorType`: SERVICE, ADMIN, MEMBER, or SYSTEM
        - `actorId`: Email, UUID, or service name
        - `targetType`: SERVICE or RESOURCE
        
        **Optional Fields:**
        - `traceId`: UUID for distributed tracing (nullable for standalone events)
        - `timestamp`: ISO 8601 timestamp (required)
        - `eventType`: User-defined event type (e.g., POLICY_CHECK, MANAGEMENT_EVENT)
        - `eventAction`: CREATE, READ, UPDATE, DELETE
        - `targetId`: Resource ID or service name
        - `requestMetadata`: JSON object with request payload (without PII/sensitive data)
        - `responseMetadata`: JSON object with response or error details
        - `additionalMetadata`: JSON object with additional context-specific data
      operationId: createAuditLog
      tags:
        - Audit Logs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAuditLogRequest'
            examples:
              policy_check:
                summary: Policy Check Event
                value:
                  traceId: "550e8400-e29b-41d4-a716-446655440000"
                  timestamp: "2024-01-20T10:00:00Z"
                  eventType: "POLICY_CHECK"
                  eventAction: "READ"
                  status: "SUCCESS"
                  actorType: "SERVICE"
                  actorId: "orchestration-engine"
                  targetType: "SERVICE"
                  targetId: "policy-decision-point"
                  requestMetadata:
                    schemaId: "schema-123"
                    requestedFields: ["name", "address"]
                  responseMetadata:
                    decision: "ALLOWED"
              management_event:
                summary: Management Event
                value:
                  traceId: null
                  timestamp: "2024-01-20T10:00:00Z"
                  eventType: "MANAGEMENT_EVENT"
                  eventAction: "CREATE"
                  status: "SUCCESS"
                  actorType: "ADMIN"
                  actorId: "admin@example.com"
                  targetType: "RESOURCE"
                  targetId: "schema-456"
                  requestMetadata:
                    resourceType: "SCHEMA"
                  additionalMetadata:
                    ipAddress: "192.168.1.1"
      responses:
        '201':
          description: Audit log created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLog'
        '400':
          description: Bad request - validation error (missing required fields or invalid enum values)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: Get Audit Logs
      description: |
        Retrieve audit logs with optional filtering. Supports filtering by trace ID and event type,
        with pagination support.
      operationId: getAuditLogs
      tags:
        - Audit Logs
      parameters:
        - name: traceId
          in: query
          description: Filter by trace ID (UUID)
          required: false
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: eventType
          in: query
          description: Filter by event type
          required: false
          schema:
            type: string
            example: "POLICY_CHECK"
        - name: limit
          in: query
          description: Maximum number of logs to return (default 100, max 1000)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          example: 100
        - name: offset
          in: query
          description: Number of logs to skip for pagination
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          example: 0
      responses:
        '200':
          description: Successfully retrieved audit logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetAuditLogsResponse'
        '400':
          description: Bad request - invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    ErrorResponse:
      type: object
      description: Error response format returned by the API
      properties:
        error:
          type: string
          description: Error message
          example: "Invalid request parameters"
        code:
          type: string
          description: Error code (optional, currently not set by implementation)
          example: "INVALID_PARAMETERS"
        details:
          type: string
          description: Additional error details containing the underlying error message
          example: "invalid timestamp format, expected RFC3339"
      required:
        - error

    CreateAuditLogRequest:
      type: object
      description: |
        Request payload for creating a generalized audit log entry.
        This matches the unified actor/target approach used in the implementation.
      properties:
        traceId:
          type: string
          format: uuid
          nullable: true
          description: Global trace ID for distributed requests (nullable for standalone events)
          example: "550e8400-e29b-41d4-a716-446655440000"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the event occurred (required)
          example: "2024-01-20T10:00:00Z"
        eventType:
          type: string
          nullable: true
          description: User-defined event type (e.g., POLICY_CHECK, MANAGEMENT_EVENT)
          example: "POLICY_CHECK"
        eventAction:
          type: string
          nullable: true
          description: Event action (CREATE, READ, UPDATE, DELETE)
          enum: [CREATE, READ, UPDATE, DELETE]
          example: "READ"
        status:
          type: string
          enum: [SUCCESS, FAILURE]
          description: Outcome of the event
          example: "SUCCESS"
        actorType:
          type: string
          enum: [SERVICE, ADMIN, MEMBER, SYSTEM]
          description: Type of actor performing the action
          example: "SERVICE"
        actorId:
          type: string
          description: Actor identifier (email, UUID, or service name)
          example: "orchestration-engine"
        targetType:
          type: string
          enum: [SERVICE, RESOURCE]
          description: Type of target being acted upon
          example: "SERVICE"
        targetId:
          type: string
          nullable: true
          description: Target identifier (resource ID or service name)
          example: "policy-decision-point"
        requestMetadata:
          type: object
          nullable: true
          description: Request payload without PII/sensitive data (JSON object)
          additionalProperties: true
          example:
            schemaId: "schema-123"
            requestedFields: ["name", "address"]
        responseMetadata:
          type: object
          nullable: true
          description: Response or error details (JSON object)
          additionalProperties: true
          example:
            decision: "ALLOWED"
            policyId: "policy-456"
        additionalMetadata:
          type: object
          nullable: true
          description: Additional context-specific data (JSON object)
          additionalProperties: true
          example:
            ipAddress: "192.168.1.1"
            userAgent: "Mozilla/5.0"
      required:
        - timestamp
        - status
        - actorType
        - actorId
        - targetType

    AuditLog:
      type: object
      description: Generalized audit log entry response
      properties:
        id:
          type: string
          format: uuid
          description: Unique database identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        traceId:
          type: string
          format: uuid
          nullable: true
          description: Global trace ID (nullable for standalone events)
          example: "550e8400-e29b-41d4-a716-446655440000"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the event occurred
          example: "2024-01-20T10:00:00Z"
        eventType:
          type: string
          nullable: true
          description: User-defined event type
          example: "POLICY_CHECK"
        eventAction:
          type: string
          nullable: true
          description: Event action
          enum: [CREATE, READ, UPDATE, DELETE]
          example: "READ"
        status:
          type: string
          enum: [SUCCESS, FAILURE]
          description: Outcome of the event
          example: "SUCCESS"
        actorType:
          type: string
          enum: [SERVICE, ADMIN, MEMBER, SYSTEM]
          description: Type of actor performing the action
          example: "SERVICE"
        actorId:
          type: string
          description: Actor identifier
          example: "orchestration-engine"
        targetType:
          type: string
          enum: [SERVICE, RESOURCE]
          description: Type of target being acted upon
          example: "SERVICE"
        targetId:
          type: string
          nullable: true
          description: Target identifier
          example: "policy-decision-point"
        requestMetadata:
          type: object
          nullable: true
          description: Request payload without PII/sensitive data
          additionalProperties: true
        responseMetadata:
          type: object
          nullable: true
          description: Response or error details
          additionalProperties: true
        additionalMetadata:
          type: object
          nullable: true
          description: Additional context-specific data
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
          description: When the record was created in the database
          example: "2024-01-20T10:00:00Z"
      required:
        - id
        - timestamp
        - status
        - actorType
        - actorId
        - targetType
        - createdAt

    GetAuditLogsResponse:
      type: object
      description: Paginated list response for audit logs
      properties:
        logs:
          type: array
          items:
            $ref: '#/components/schemas/AuditLog'
          description: List of audit log entries
        total:
          type: integer
          format: int64
          description: Total number of logs matching the filter
          example: 150
        limit:
          type: integer
          description: The number of logs returned in this response
          example: 100
        offset:
          type: integer
          description: The offset used for this response
          example: 0
      required:
        - logs
        - total
        - limit
        - offset

tags:
  - name: Health
    description: Health check endpoints

  - name: Audit Logs
    description: General purpose distributed audit logging

