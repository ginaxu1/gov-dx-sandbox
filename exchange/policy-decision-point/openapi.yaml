openapi: 3.0.3
info:
  title: Policy Decision Point API
  description: |
    Policy Decision Point API for making authorization decisions in the Data Exchange Platform.
    This service evaluates data access requests against policies and determines if consent is required.
    The service uses database-driven metadata management and supports real-time policy updates.
  version: 1.0.0
  contact:
    name: Gov DX Sandbox Team
    email: support@gov-dx-sandbox.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8082
    description: Local Development Environment

paths:
  /health:
    get:
      summary: Health Check
      description: Check if the policy decision point service is running and healthy
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: "policy-decision-point"
                  status:
                    type: string
                    example: healthy
  /api/v1/policy/decide:
    post:
      summary: Make Policy Decision
      description: Evaluate data access request against policies and return authorization decision with consent requirements.
      tags:
        - Policy Decision
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyDecisionRequest'
      responses:
        '200':
          description: Policy Decision Retrieved Successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyDecisionResponse'
        '400':
          description: Bad request - invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/policy/update-allowlist:
    post:
      summary: Update Allow List for Data Fields
      description: Update the allow list for data fields to grant application access. This endpoint should be called when a consumer application is approved for access to specific data fields.
      tags:
        - Policy Metadata Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AllowListUpdateRequest'
      responses:
        '200':
          description: Allow list updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllowListUpdateResponse'
        '400':
          description: Bad request - invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Field not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/policy/metadata:
    post:
      summary: Create or Update Policy Metadata
      description: Create or update policy metadata records for data fields when the Provider schema is approved.
      tags:
        - Policy Metadata Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyMetadataCreateRequest'
      responses:
        '201':
          description: Policy metadata created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyMetadataCreateResponse'
        '400':
          description: Bad request - invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /debug:
    get:
      summary: Debug Information
      description: Get debug information about the policy decision point service
      operationId: getDebugInfo
      tags:
        - Debug
      responses:
        '200':
          description: Debug information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebugResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    PolicyDecisionRequest:
      type: object
      required:
        - consumerId
        - applicationId
        - requestId
        - requiredFields
      properties:
        consumerId:
          type: string
          description: ID of the consumer that owns the application
          example: die
        applicationId:
          type: string
          description: ID of the application making the request
          example: passport-app
        requestId:
          type: string
          description: Unique identifier for this request
          example: request_123
        requiredFields:
          type: array
          description: List of data fields being requested
          items:
            type: object
            properties:
              schemaId:
                type: string
                description: Identifier of the data schema
              fieldName:
                type: string
                description: Raw Schema Mapping of the data field being requested
    PolicyDecisionResponse:
      type: object
      properties:
        appAuthorized:
          type: boolean
          description: Whether the request is allowed
          example: true
        unAuthorizedFields:
          type: array
          description: List of fields that are not authorized
          items:
            $ref: '#/components/schemas/PolicyDecisionResponseRecordInfo'
        appAccessExpired:
          type: boolean
          description: Whether the application's access has expired
          example: false
        expiredFields:
          type: array
          description: List of fields for which access has expired
          items:
            $ref: '#/components/schemas/PolicyDecisionResponseRecordInfo'
        appRequiresOwnerConsent:
          type: boolean
          description: Whether the application requires owner consent
          example: true
        consentRequiredFields:
          type: array
          description: List of fields that require owner consent
          items:
            $ref: '#/components/schemas/PolicyDecisionResponseRecordInfo'

    PolicyDecisionResponseRecordInfo:
      type: object
      properties:
        fieldName:
          type: string
          description: Name of the data field
          example: "person.fullName"
        schemaId:
          type: string
          description: Identifier of the data schema
          example: "schema_001"
        displayName:
          type: string
          description: Human-readable display name for the field
          example: "Full Name"
        description:
          type: string
          description: Description of the data field
          example: "Complete name of the person"
        owner:
          type: string
          example: "citizen"

    DebugResponse:
      type: object
      properties:
        service:
          type: string
          description: Name of the service
          example: policy-decision-point
        version:
          type: string
          description: Service version
          example: "1.0.0"
        uptime:
          type: string
          description: Service uptime
          example: "2h 15m 30s"
        policies_loaded:
          type: integer
          description: Number of policies loaded
          example: 5
        policy_files:
          type: array
          description: List of loaded policy files
          items:
            type: string
          example: [ "main.rego", "field_access.rego" ]
        configuration:
          type: object
          description: Service configuration
          properties:
            environment:
              type: string
              example: local
            log_level:
              type: string
              example: debug
            port:
              type: integer
              example: 8082

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: "Invalid request format"
        code:
          type: string
          description: Error code
          example: "INVALID_REQUEST"
        details:
          type: object
          description: Additional error details
          properties:
            field:
              type: string
              description: Field that caused the error
              example: "application_id"
            message:
              type: string
              description: Detailed error message
              example: "application_id is required"

    PolicyMetadataCreateRequest:
      type: object
      required:
        - schemaId
        - records
      properties:
        schemaId:
          type: string
          description: Identifier of the data schema
          example: "schema_001"
        records:
          type: array
          description: List of policy metadata records to create
          items:
            $ref: '#/components/schemas/PolicyMetadataCreateRequestRecord'

    PolicyMetadataCreateRequestRecord:
      type: object
      required:
        - fieldName
        - source
        - isOwner
        - accessControlType
      properties:
        fieldName:
          type: string
          description: Name of the field being created
          example: "person.fullName"
        displayName:
          type: string
          description: Human-readable display name for the field
          example: "Full Name"
        description:
          type: string
          description: Description of the field
          example: "Complete name of the person"
        source:
          type: string
          description: Source system for this field
          enum: [ "primary", "fallback" ]
          example: "primary"
        isOwner:
          type: boolean
          description: Whether the field owner is the data owner
          example: true
        accessControlType:
          type: string
          description: Access control type for the field
          enum: [ "public", "restricted" ]
          example: "restricted"


    PolicyMetadataCreateResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the creation was successful
          example: true
        message:
          type: string
          description: Human-readable message about the creation
          example: "Created policy metadata for field person.fullName"
        id:
          type: string
          description: UUID of the created policy metadata record
          example: "123e4567-e89b-12d3-a456-426614174000"

    AllowListUpdateRequest:
      type: object
      required:
        - applicationId
        - grantDuration
        - records
      properties:
        applicationId:
          type: string
          description: App that is being granted access
          example: "passport-app"
        grantDuration:
          type: string
          description: Duration of access grant in format like 30d, 1h, etc.
          example: "30d"
        records:
          type: array
          description: List of field records to update the allow list for
          items:
            type: object
            required:
              - fieldName
              - schemaId
            properties:
              fieldName:
                type: string
                description: Name of the field to update
                example: "person.fullName"
              schemaId:
                type: string
                description: Identifier of the data schema
                example: "schema_001"

    AllowListUpdateResponse:
      type: object
      properties:
        records:
          type: array
          description: List of updated field records
          items:
            type: object
            properties:
              fieldName:
                type: string
                description: Name of the field updated
                example: "person.fullName"
              schemaId:
                type: string
                description: Identifier of the data schema
                example: "schema_001"
              applicationId:
                type: string
                description: ID of the application granted access
                example: "passport-app"
              expiresAt:
                type: string
                description: Expiration timestamp as a string (e.g., Unix timestamp or ISO 8601)
                example: "1704067199"

tags:
  - name: Health
    description: Health check endpoints
  - name: Policy Decision
    description: Policy decision and authorization operations
  - name: Debug
    description: Debug and diagnostic operations
  - name: Policy Metadata Management
    description: Policy metadata and allow list management operations
